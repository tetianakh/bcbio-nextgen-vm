---
- name: Install goofys and mount S3 bucket
  hosts: all
  vars:
    goofys_file: /usr/local/bin/goofys
    goofys_url: https://github.com/kahing/goofys/releases/download/v0.0.8/goofys
    S3_endpoint: s3.eu-central-1.amazonaws.com
    S3_bucket: testbcbio
    S3_mount_point: /mnt/S3
  tasks:
    - name: Download goofys 
      get_url:
        url: "{{ goofys_url }}"
        dest: "{{ goofys_file }}"
        force: yes
        mode: 0755
      sudo: True

    - stat: path="{{ S3_mount_point }}"
      register: dir

    - name: Create mount directory
      file: path="{{ S3_mount_point }}" state=directory owner="ubuntu"
      when: dir.stat.exists == False
      sudo: True

    - name: Mount S3 bucket  
      shell: goofys --endpoint "{{ S3_endpoint }}" "{{ S3_bucket }}" "{{ S3_mount_point }}"

    - name: Check if the bucket is mounted
      command: "grep -s {{ S3_bucket }} /proc/mounts"
